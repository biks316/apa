<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fetched Documents</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.1.2/dist/tailwind.min.css" rel="stylesheet">
    <!-- Awesomplete CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.css" />
    <!-- Fuse.js for fuzzy search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>
    <style>
        th.sortable { cursor: pointer; }
        th.sorted-asc::after { content: " \25B2"; }
        th.sorted-desc::after { content: " \25BC"; }
        .awesomplete { width: 100% !important; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex">
        <!-- Sidebar -->
        <aside class="w-64 bg-gray-100 border-r min-h-screen py-8 px-4">
            <h2 class="text-xl font-bold mb-6">Database Tables</h2>
            <ul class="space-y-2">
                {% for name, url in sidebar_tables %}
                <li>
                    <a href="{{ url }}" class="block px-4 py-2 rounded hover:bg-blue-100 text-blue-700 font-semibold">{{ name }}</a>
                </li>
                {% endfor %}
            </ul>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 px-8 py-8">
            <h1 class="text-3xl font-bold mb-6">Fetched Documents</h1>

            <!-- Search and Filter Controls -->
        <div class="flex flex-wrap gap-4 mb-4">
            <input type="text" id="searchInput" placeholder="Search by topic, title, summary..." class="p-2 border rounded w-full md:w-1/3 awesomplete" oninput="filterTable()" autocomplete="off">
            <select id="topicFilter" class="p-2 border rounded w-full md:w-1/4" onchange="filterTable()">
                <option value="">All Topics</option>
                {% for topic in topics %}
                    <option value="{{ topic }}">{{ topic }}</option>
                {% endfor %}
            </select>
        </div>

        <table id="docsTable" class="min-w-full bg-white rounded-lg shadow-md">
            <thead>
                <tr>
                    <th class="py-2 px-4 border-b sortable" onclick="sortTable(0)">ID</th>
                    <th class="py-2 px-4 border-b sortable" onclick="sortTable(1)">Topic</th>
                    <th class="py-2 px-4 border-b sortable" onclick="sortTable(2)">Title</th>
                    <th class="py-2 px-4 border-b sortable" onclick="sortTable(3)">Summary</th>
                    <th class="py-2 px-4 border-b">Source URL</th>
                    <th class="py-2 px-4 border-b sortable" onclick="sortTable(5)">Fetched At</th>
                </tr>
            </thead>
            <tbody>
                {% for doc in documents %}
                <tr class="hover:bg-gray-100">
                    <td class="py-2 px-4 border-b">{{ doc.id }}</td>
                    <td class="py-2 px-4 border-b">{{ doc.topic.name }}</td>
                    <td class="py-2 px-4 border-b">{{ doc.title }}</td>
                    <td class="py-2 px-4 border-b">{{ doc.summary|truncatechars:120 }}</td>
                    <td class="py-2 px-4 border-b"><a href="{{ doc.source_url }}" class="text-blue-600 underline" target="_blank">Link</a></td>
                    <td class="py-2 px-4 border-b">{{ doc.fetched_at }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="6" class="py-4 text-center text-gray-500">No documents found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
    <!-- Awesomplete JS -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js"></script>

    <script>
    // AJAX + Fuse.js fuzzy Autocomplete setup
    document.addEventListener("DOMContentLoaded", function() {
        var input = document.getElementById("searchInput");
        var awesomplete = new Awesomplete(input, {
            minChars: 3,
            maxItems: 10,
            autoFirst: true
        });
        var allSuggestions = [];
        var fuse = null;
        var lastQuery = "";
        input.addEventListener("input", function() {
            var val = input.value;
            if (val.length < 3) {
                awesomplete.list = [];
                return;
            }
            // Only fetch once per session, or refetch if query changes significantly
            if (!allSuggestions.length || val.slice(0,3) !== lastQuery.slice(0,3)) {
                fetch(`/generate/autocomplete/?q=${encodeURIComponent(val)}&page=1`)
                    .then(response => response.json())
                    .then(data => {
                        allSuggestions = data.results || [];
                        fuse = new Fuse(allSuggestions, { includeScore: true, threshold: 0.4 });
                        updateFuzzy(val);
                    });
                lastQuery = val;
            } else {
                updateFuzzy(val);
            }
        });
        function updateFuzzy(val) {
            if (!fuse) return;
            var results = fuse.search(val).map(r => r.item).slice(0, 10);
            awesomplete.list = results;
        }
        input.addEventListener("awesomplete-selectcomplete", function(e) {
            filterTable();
        });
    });

    // Search and filter
    function filterTable() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const topic = document.getElementById('topicFilter').value;
        const table = document.getElementById('docsTable');
        const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].getElementsByTagName('td');
            const topicText = cells[1]?.textContent.toLowerCase();
            const titleText = cells[2]?.textContent.toLowerCase();
            const summaryText = cells[3]?.textContent.toLowerCase();
            let show = true;
            if (search && !(topicText.includes(search) || titleText.includes(search) || summaryText.includes(search))) {
                show = false;
            }
            if (topic && topicText !== topic.toLowerCase()) {
                show = false;
            }
            rows[i].style.display = show ? '' : 'none';
        }
    }

    // Sort table
    let sortCol = null;
    let sortDir = 1;
    function sortTable(col) {
        const table = document.getElementById('docsTable');
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);
        // Remove sort indicators
        Array.from(table.tHead.rows[0].cells).forEach(th => {
            th.classList.remove('sorted-asc', 'sorted-desc');
        });
        // Sort
        rows.sort((a, b) => {
            let aText = a.cells[col].textContent.trim();
            let bText = b.cells[col].textContent.trim();
            if (!isNaN(Date.parse(aText)) && !isNaN(Date.parse(bText))) {
                aText = new Date(aText);
                bText = new Date(bText);
            } else if (!isNaN(aText) && !isNaN(bText)) {
                aText = Number(aText);
                bText = Number(bText);
            }
            if (aText < bText) return -sortDir;
            if (aText > bText) return sortDir;
            return 0;
        });
        // Re-append rows
        rows.forEach(row => tbody.appendChild(row));
        // Add sort indicator
        table.tHead.rows[0].cells[col].classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');
        // Toggle direction for next click
        if (sortCol === col) sortDir *= -1; else { sortCol = col; sortDir = 1; }
    }
    </script>
</body>
</html>
